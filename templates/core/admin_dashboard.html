{% extends 'base.html' %}

{% block title %}Admin Dashboard - Student Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar">
            <div class="p-3">
                <h6 class="text-muted mb-3">ADMIN PANEL</h6>
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#overview" data-bs-toggle="tab">
                            <i class="fas fa-tachometer-alt me-2"></i>Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#users" data-bs-toggle="tab">
                            <i class="fas fa-users me-2"></i>Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#departments" data-bs-toggle="tab">
                            <i class="fas fa-building me-2"></i>Departments
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#courses" data-bs-toggle="tab">
                            <i class="fas fa-book me-2"></i>Courses
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
            <div class="p-4">
                <div class="tab-content">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview">
                        <h2 class="mb-4">System Overview</h2>
                        
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4>{{ total_users }}</h4>
                                                <p class="mb-0">Total Users</p>
                                            </div>
                                            <i class="fas fa-users fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4>{{ total_students }}</h4>
                                                <p class="mb-0">Students</p>
                                            </div>
                                            <i class="fas fa-user-graduate fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4>{{ total_lecturers }}</h4>
                                                <p class="mb-0">Lecturers</p>
                                            </div>
                                            <i class="fas fa-chalkboard-teacher fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4>{{ total_courses }}</h4>
                                                <p class="mb-0">Courses</p>
                                            </div>
                                            <i class="fas fa-book fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Recent Activities</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="list-group list-group-flush">
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-user-plus text-success me-2"></i>
                                                    New student registered
                                                </div>
                                                <small class="text-muted">2 hours ago</small>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-book text-primary me-2"></i>
                                                    Course CS301 created
                                                </div>
                                                <small class="text-muted">1 day ago</small>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-building text-info me-2"></i>
                                                    Department updated
                                                </div>
                                                <small class="text-muted">2 days ago</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Quick Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary" onclick="showCreateUserModal()">
                                                <i class="fas fa-user-plus me-2"></i>Add New User
                                            </button>
                                            <button class="btn btn-success" onclick="showCreateDepartmentModal()">
                                                <i class="fas fa-building me-2"></i>Add Department
                                            </button>
                                            <button class="btn btn-info" onclick="showCreateCourseModal()">
                                                <i class="fas fa-book me-2"></i>Add Course
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Tab -->
                    <div class="tab-pane fade" id="users">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>User Management</h2>
                            <button class="btn btn-primary" onclick="showCreateUserModal()">
                                <i class="fas fa-plus me-2"></i>Add User
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h5 class="mb-0">All Users</h5>
                                    </div>
                                    <div class="col-auto">
                                        <input type="text" class="form-control" placeholder="Search users..." id="userSearch">
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Name</th>
                                                <th>Username</th>
                                                <th>Email</th>
                                                <th>Role</th>
                                                <th>Department</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody">
                                            {% for user in users %}
                                            <tr>
                                                <td>{{ user.get_full_name|default:user.username }}</td>
                                                <td>{{ user.username }}</td>
                                                <td>{{ user.email }}</td>
                                                <td>
                                                    <span class="badge bg-{% if user.role == 'admin' %}danger{% elif user.role == 'lecturer' %}success{% else %}primary{% endif %}">
                                                        {{ user.get_role_display }}
                                                    </span>
                                                </td>
                                                <td>{{ user.department.name|default:"-" }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="editUser({{ user.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="6" class="text-center py-4">No users found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Departments Tab -->
                    <div class="tab-pane fade" id="departments">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>Department Management</h2>
                            <button class="btn btn-primary" onclick="showCreateDepartmentModal()">
                                <i class="fas fa-plus me-2"></i>Add Department
                            </button>
                        </div>

                        <div class="row">
                            {% for department in departments %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <h5 class="card-title">{{ department.name }}</h5>
                                                <p class="card-text text-muted">{{ department.code }}</p>
                                            </div>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="editDepartment({{ department.id }})">
                                                        <i class="fas fa-edit me-2"></i>Edit
                                                    </a></li>
                                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteDepartment({{ department.id }})">
                                                        <i class="fas fa-trash me-2"></i>Delete
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="border-end">
                                                    <h6 class="text-primary">{{ department.course_set.count }}</h6>
                                                    <small class="text-muted">Courses</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <h6 class="text-success">{{ department.user_set.count }}</h6>
                                                <small class="text-muted">Members</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12">
                                <div class="text-center py-5">
                                    <i class="fas fa-building fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No departments found</h5>
                                    <p class="text-muted">Create your first department to get started.</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Courses Tab -->
                    <div class="tab-pane fade" id="courses">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>Course Management</h2>
                            <button class="btn btn-primary" onclick="showCreateCourseModal()">
                                <i class="fas fa-plus me-2"></i>Add Course
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h5 class="mb-0">All Courses</h5>
                                    </div>
                                    <div class="col-auto">
                                        <select class="form-select" id="departmentFilter">
                                            <option value="">All Departments</option>
                                            {% for department in departments %}
                                            <option value="{{ department.id }}">{{ department.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Code</th>
                                                <th>Title</th>
                                                <th>Unit</th>
                                                <th>Department</th>
                                                <th>Lecturers</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for course in courses %}
                                            <tr>
                                                <td><strong>{{ course.code }}</strong></td>
                                                <td>{{ course.title }}</td>
                                                <td>{{ course.unit }}</td>
                                                <td>{{ course.department.name }}</td>
                                                <td>
                                                    {% for lecturer in course.lecturers.all %}
                                                        <span class="badge bg-secondary me-1">{{ lecturer.get_full_name|default:lecturer.username }}</span>
                                                    {% empty %}
                                                        <span class="text-muted">No lecturers assigned</span>
                                                    {% endfor %}
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="editCourse({{ course.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCourse({{ course.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="6" class="text-center py-4">No courses found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
{% include 'core/modals/user_modal.html' %}
{% include 'core/modals/department_modal.html' %}
{% include 'core/modals/course_modal.html' %}
{% endblock %}

{% block extra_js %}
<script>
// User management functions
function showCreateUserModal() {
    document.getElementById('userModalTitle').textContent = 'Add New User';
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    new bootstrap.Modal(document.getElementById('userModal')).show();
}

function editUser(userId) {
    // Fetch user data and populate modal
    fetch(`/admin/users/${userId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = data.id;
            document.getElementById('username').value = data.username;
            document.getElementById('email').value = data.email;
            document.getElementById('firstName').value = data.first_name;
            document.getElementById('lastName').value = data.last_name;
            document.getElementById('role').value = data.role;
            document.getElementById('department').value = data.department;
            new bootstrap.Modal(document.getElementById('userModal')).show();
        });
}

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
        fetch(`/admin/users/${userId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        }).then(() => location.reload());
    }
}

// Department management functions
function showCreateDepartmentModal() {
    document.getElementById('departmentModalTitle').textContent = 'Add New Department';
    document.getElementById('departmentForm').reset();
    document.getElementById('departmentId').value = '';
    new bootstrap.Modal(document.getElementById('departmentModal')).show();
}

function editDepartment(departmentId) {
    fetch(`/admin/departments/${departmentId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('departmentModalTitle').textContent = 'Edit Department';
            document.getElementById('departmentId').value = data.id;
            document.getElementById('departmentName').value = data.name;
            document.getElementById('departmentCode').value = data.code;
            new bootstrap.Modal(document.getElementById('departmentModal')).show();
        });
}

function deleteDepartment(departmentId) {
    if (confirm('Are you sure you want to delete this department?')) {
        fetch(`/admin/departments/${departmentId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        }).then(() => location.reload());
    }
}

// Course management functions
function showCreateCourseModal() {
    document.getElementById('courseModalTitle').textContent = 'Add New Course';
    document.getElementById('courseForm').reset();
    document.getElementById('courseId').value = '';
    new bootstrap.Modal(document.getElementById('courseModal')).show();
}

function editCourse(courseId) {
    fetch(`/admin/courses/${courseId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('courseModalTitle').textContent = 'Edit Course';
            document.getElementById('courseId').value = data.id;
            document.getElementById('courseCode').value = data.code;
            document.getElementById('courseTitle').value = data.title;
            document.getElementById('courseUnit').value = data.unit;
            document.getElementById('courseDepartment').value = data.department;
            new bootstrap.Modal(document.getElementById('courseModal')).show();
        });
}

function deleteCourse(courseId) {
    if (confirm('Are you sure you want to delete this course?')) {
        fetch(`/admin/courses/${courseId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        }).then(() => location.reload());
    }
}
</script>
{% endblock %}
